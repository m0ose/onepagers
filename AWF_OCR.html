<html>
<script src="https://www.gstatic.com/firebasejs/7.13.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.13.2/firebase-analytics.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.13.2/firebase-database.js"></script>
<script type=module>
import * as workQ from 'https://redfishgroup.github.io/firebase_worker_queue/src/queue.js'
import { OCRAlertWildfireImage } from 'https://redfishgroup.github.io/redfish-core/lib/alertWildfire/ocr.js'
// import {timeoutDelay} from "https://redfishgroup.github.io/redfish-core/lib/utils/utils.js"

var queuedTasks = []
var busyWithTask = false

const config = {
    apiKey: 'AIzaSyDZiLOsrcCeYsDe1kGyORPpExVNBwzpmqY',
    projectId: 'acequia',
    databaseURL: 'https://acequia.firebaseio.com/',
}
firebase.initializeApp(config)
const db = firebase.database()
const aGoodQueue = db.ref().child('awf_v0').child('OCR_workerQueue')
const VERSION = 0.7 // If you update the version it should reload all of the other pages on the other machines. 

function main() {
    polling()
    initQueueMonitor(aGoodQueue)
    requeueStailActiveTasksMonitor(aGoodQueue)
    updateVersion(aGoodQueue)
}
setTimeout(main);

async function polling() {
    console.log('polling')
    if (!busyWithTask && !document.hidden) {
        await popNextOffQueue()
    }
    setTimeout(polling, 600)
}

workQ.watchQueue(aGoodQueue, async (task) => {
    queuedTasks.push(task)
})

async function popNextOffQueue() {
    const task = queuedTasks.pop()
    if (!task) return
    console.log('Q:', task)
    // if(task && task.mediaObject && task.mediaObject.src){
    //const mobj = await getMediaObj(db.ref(), task.mediaObject.src)
    const mobj = task.mediaObject
    if (!mobj) {
        workQ.errorTask(
            aGoodQueue,
            task,
            `Media Object Not Found ${task.mediaObject}`
        )
        return
    }

    if (!mobj.ocrValues) {
        console.log('found task')
        busyWithTask = true
        try {
            await timeoutDelay(Math.random() * 200) // delay it a bit so that one computer does not take every ticket
            const ticket = await workQ.claimTask(
                aGoodQueue,
                task,
                `CS ${Math.random()}`
            )
            try {
                console.log('ocr ticket', ticket)
                await runOCR(aGoodQueue, ticket, mobj)
                console.log('done ocr')
            } catch (err) {
                console.error(err)
            }
        } catch (err) {
            console.log('failed to claim', err)
        }
        busyWithTask = false
    }
}

async function getMediaObj(rootRef, url) {
    const url2 = url.replace('https://acequia.firebaseio.com/', '')
    const ref = rootRef.child(url2)
    const meob = await ref.once('value')
    const result = meob.val()
    return result
}

// todo get from redfish-core
export const timeoutDelay = (ms) => new Promise((res) => setTimeout(res, ms))

function cancelSeekWait(vidDiv) {
    vidDiv.onloadeddata = undefined
    vidDiv.onseeked = undefined
}

async function awaitSeekEvent(vidDiv, timeSec1) {
    const timeSec2 = Math.max(timeSec1, 0)

    const result = new Promise((resolve, reject) => {
        
        // Make a timeout
        const timeoutID = setTimeout(() => {
            cancelSeekWait(vidDiv)
            reject({
                msg: 'Failed to get seek event. Might be in background tab',
                requeueTask: true,
            })
        }, 20000)
        //
        vidDiv.onerror = (err) => {
            cancelSeekWait(vidDiv)
            console.error(err)
            reject({ requeueTask: false, msg: 'Failed to load Video' })
        }
        console.log('waiting seek event...')
        vidDiv.onloadeddata = (ev)=>{
            if (timeSec2 == 0) { 
                resolve(true) 
            }
            else {
                vidDiv.onseeked = function cb(ev) {
                    clearTimeout(timeoutID)
                    console.log('got seek event', vidDiv.currentTime, ev)
                    resolve(true)
                }
                vidDiv.currentTime = vidDiv.duration * timeSec2
            }
        }
    })

    return result
}

async function runOCR(ref, task, mediaObj) {
    console.log('running ocr on', task, mediaObj)
    const vidDiv = document.createElement('video')
    vidDiv.src = mediaObj.src
    vidDiv.preload = 'auto'
    vidDiv.playsInline = true
    vidDiv.muted = true
    vidDiv.crossOrigin = 'anonymous'
    //setTimeout(()=>{vidDiv.currentTime = task.mediaTimeSeconds},100)
    const mediaTime = task.mediaTimeSeconds
    try {
        const ev = await awaitSeekEvent(vidDiv, mediaTime)
        console.log('seeked', ev)
    } catch (err) {
        cancelSeekWait(vidDiv)
        console.error(err)
        // workQ.errorTask(ref,task,err)
        if (err.requeueTask) {
            console.log('requeueing task')
            workQ.changeTaskStatus(ref, task, workQ.STATUSES.available, {
                requeue: true,
            })
        } else {
            console.log('errored task')
            workQ.errorTask(ref, task, err)
        }
        return
    }
    try {
        const can = vidToCanvas(vidDiv, 1)
        const result = await OCRAlertWildfireImage(
            can,
            'https://redfishgroup.github.io/redfish-core/externalJS/',
            (msg) => {
                const message = `${msg.status}    ${100 * msg.progress}%`
                console.info(message)
            }
        )
        const myResult = {
            ...result,
            time: result.date.getTime(),
            VERSION,
            sponsor: 'Northern Mexico Cricket Racing League',
        }
        myResult.width = can.width
        myResult.height = can.height
        myResult.aspectRatio = can.width / can.height
        console.log({ result, myResult })
        workQ.completeTask(ref, task, myResult)
        displayResult(can, myResult)
    } catch (err) {
        // this is not getting called
        console.error(err)
        workQ.errorTask(ref, task, err)
    }
}


window.addTask = async function (mediaObj, mediaTimeSec = 0) {
    const taskTask = await workQ.addTask(aGoodQueue, {
        mediaObject: mediaObj,
        mediaTimeSeconds: mediaTimeSec,
        signed: 'horchatasaurus',
    })
    console.log('Task Description:', taskTask)
    const a = await wrapTaskListener(aGoodQueue, taskTask)
    console.log('done:', a.result)
}

function wrapTaskListener(ref, task) {
    return new Promise((resolve, reject) => {
        workQ.taskListener(
            aGoodQueue,
            task,
            (a) => {
                resolve(a)
            },
            (err) => {
                reject(err)
            }
        )
    })
}

function vidToCanvas(vid, scale = 1) {
    const can = document.createElement('canvas')
    can.crossOrigin = 'anonymous'
    can.setAttribute('crossorigin', 'anonymous')
    can.width = Math.round(vid.videoWidth * scale)
    can.height = Math.round(vid.videoHeight * scale)
    const ctx = can.getContext('2d')
    ctx.drawImage(vid, 0, 0, can.width, can.height)
    return can
}

function displayResult(can, result) {
    const dv = document.createElement('div')
    if (can) {
        const currDiv = document.getElementById('currImg')
        currDiv.innerHTML = ''
        currDiv.appendChild(can)
    }
    dv.innerHTML = `${JSON.stringify(result, 0, 2)}<hr>`
    document.body.appendChild(dv)
}

/**
 * Monitor Queue state
 * */

function initQueueMonitor(aDecentQueue) {
    aDecentQueue
    console.log({aDecentQueue})
    aDecentQueue.child('active').on('value',(snap)=>{
        console.log('active: ',snap.numChildren())
        document.getElementById('activeCount').innerHTML = `${snap.numChildren()}`
    })
    aDecentQueue.child('error').on('value',(snap)=>{
        console.log('error: ',snap.numChildren())
        document.getElementById('errorsCount').innerHTML = `${snap.numChildren()}`
    })
    aDecentQueue.child('complete').on('value',(snap)=>{
        console.log('complete: ',snap.numChildren())
        document.getElementById('completeCount').innerHTML = `${snap.numChildren()}`
    })
    aDecentQueue.child('available').on('value',(snap)=>{
        console.log('available: ',snap.numChildren())
        document.getElementById('availableCount').innerHTML = `${snap.numChildren()}`
    })
    //available
}


/**
 * Monitor for stuck active tasks.  
 * */
function requeueStailActiveTasksMonitor(aFairQueue) {
    setTimeout(async () => {
            await workQ.requeueStaleActiveTasks(aFairQueue)
            requeueStailActiveTasksMonitor(aFairQueue)
    }, 1000);
}

/**
* update version
* */
async function updateVersion(ref) {
    const snap1 = await ref.child('VERSION').once('value')
    const v = snap1.val()
    if(v<VERSION) {
        await ref.child('VERSION').set(VERSION)
    }
    ref.child('VERSION').on('value',async (snap)=>{
        const val = snap.val()
        if(val>VERSION) {
            console.log('new version avaliable', val, ' ... reloading')
            await timeoutDelay(10000) // wait 10 seconds to slow down a mysterious reload loop
            for(let i=0; i<100 && busyWithTask;i++){ // wait a maximum of 100 seconds to reload
                await timeoutDelay(1000)
            }
            window.location.reload()
        }
    })
}


    </script>
<h2>Ready for event</h2>
<div>
    <h4>
        Adding an event would look something like this
    </h4>
    <div>
        <h4>Queue State</h4>
        <div><b>Available:</b><span id="availableCount"></span></div>
        <div><b>Active:</b><span id='activeCount'></span></div>
        <div><b>Errors:</b><span id='errorsCount'></span></div>
        <div><b>Complete:</b><span id='completeCount'></span></div>
    </div>
    <pre>
            const db = firebase.database()
            const aGoodQueue = db.ref().child('awf_v0').child('workerQueue')
            window.addTask = function(mediaObj, mediaTimeSec=3*Math.random()){
                workQ.addTask(aGoodQueue,{
                    mediaObject:mediaObj,
                    mediaTimeSeconds:mediaTimeSec,
                    signed:'horchatasaurus'
                }) 
            }
            addTask("https://acequia.firebaseio.com/awf_v0/cameras/58a0233c-83b2-412d-97b2-49ec74d0e9d3/mediaObjects/7056698d-0f1f-44b8-aa3f-e75aa97ee050")    
        </pre>
</div>

<div id=currImg></div>

</html>