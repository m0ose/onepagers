<html>
<script src="https://www.gstatic.com/firebasejs/7.13.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.13.2/firebase-analytics.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.13.2/firebase-database.js"></script>
<script type=module>
        import * as workQ from "https://redfishgroup.github.io/firebase_worker_queue/src/queue.js"
        import {OCRAlertWildfireImage} from "https://redfishgroup.github.io/redfish-core/lib/alertWildfire/ocr.js"
        // import {timeoutDelay} from "https://redfishgroup.github.io/redfish-core/lib/utils/utils.js"

        const config = {
            "apiKey": "AIzaSyDZiLOsrcCeYsDe1kGyORPpExVNBwzpmqY",
            "projectId" : "acequia",
            "databaseURL": "https://acequia.firebaseio.com/",
        }
        firebase.initializeApp(config);
        const db = firebase.database()
        const aGoodQueue = db.ref().child('awf_v0').child('OCR_workerQueue')
        window.addTask = async function(mediaObj, mediaTimeSec=3*Math.random()){
            const taskTask = await workQ.addTask(aGoodQueue,{
                mediaObject:mediaObj,
                mediaTimeSeconds:mediaTimeSec,
                signed:'horchatasaurus'
            }) 
            console.log("Task Description:",taskTask)
            const a = await wrapTaskListener(aGoodQueue, taskTask)
            console.log('done:',a.result)
        }

        function wrapTaskListener(ref, task){
            return new Promise((resolve,reject)=>{
                workQ.taskListener(aGoodQueue, task,(a)=>{
                    resolve(a)
                }, (err)=>{
                    reject(err)
                })
            })
        }

        //test
        //addTask({src:"https://acequia.firebaseio.com/awf_v0/cameras/Axis-Atlas/mediaObjects/https:dwhjps6y1v79ncloudfrontnetfirecamsvideosAxis-Atlashourly2020271271_19mp4"})
        
        // Watch the queue
        var queuedTasks=[]
        var busyWithTask = false

        async function main(){
            console.log('main')
            if(!busyWithTask){
                await popNextOffQueue()
            } else {
                console.warn('too busy to take another task now')
            }
            setTimeout(main, 1000);
        }
        main()


        workQ.watchQueue(aGoodQueue, async task => {
           queuedTasks.push(task)
        })


        async function popNextOffQueue() {
            const task = queuedTasks.pop()
            if(!task)return
            console.log('Q:',task)
            // if(task && task.mediaObject && task.mediaObject.src){
            //const mobj = await getMediaObj(db.ref(), task.mediaObject.src)
            const mobj = task.mediaObject
           if(!mobj) {
            workQ.errorTask(aGoodQueue, task, `Media Object Not Found ${task.mediaObject}`)
            return
           }

           if(!mobj.ocrValues) {
                console.log('found task')
                busyWithTask = true
                try {
                    await timeoutDelay(Math.random()*2000) // delay it a bit so that one computer does not take every ticket
                    const ticket = await workQ.claimTask(aGoodQueue, task, `Redolpho the rocket snail ${Math.random()}`)
                    try{
                        console.log('ocr ticket', ticket)
                        await runOCR(aGoodQueue, ticket, mobj) 
                        console.log('done ocr')
                    } catch(err){
                        console.error(err)
                    }
                } catch(err){
                    console.log('failed to claim',err)
                }
                busyWithTask = false
           }
        }

        async function getMediaObj(rootRef, url) {
            const url2 = url.replace('https://acequia.firebaseio.com/','')
            const ref = rootRef.child(url2)
            const meob = await ref.once('value')
            const result = meob.val()
            return result
        }

        export const timeoutDelay = (ms) => new Promise((res) => setTimeout(res, ms))

        async function awaitSeekEvent(vidDiv, timeSec1){
            console.log('aardvark',timeSec1)
            const timeSec2 = Math.max(timeSec1, 0)

            const result = new Promise((resolve,reject)=>{
                
                const timeoutID = setTimeout(() => {
                    reject('Failed to get seek event. Might be in background tab')
                }, 10000);
                console.log('waiting seek event...')
                    if(timeSec2 ==0) {
                    vidDiv.addEventListener('loadeddata',(ev)=>{
                        clearTimeout(timeoutID)
                        console.log('got loaded event',ev)
                        resolve(true)
                    })
                } else {
                    vidDiv.addEventListener('seeked',(ev)=>{
                        clearTimeout(timeoutID)
                        console.log('got seek event',ev)
                        resolve(ev)
                    })
                }
            })

            vidDiv.currentTime = timeSec2
            return result
        }

        async function runOCR(ref, task, mediaObj) {
            console.log('running ocr on', task, mediaObj)
            const vidDiv = document.createElement('video')
            vidDiv.src = mediaObj.src
            vidDiv.preload='auto'
            vidDiv.playsInline = true
            vidDiv.muted=true
            vidDiv.crossOrigin="anonymous"
            //setTimeout(()=>{vidDiv.currentTime = task.mediaTimeSeconds},100) 
            const mediaTime = task.mediaTimeSeconds
            const ev = await awaitSeekEvent(vidDiv,mediaTime)
            try{
                console.log('seeked',ev)
                const can = vidToCanvas(vidDiv)
                const result = await OCRAlertWildfireImage(can,'https://redfishgroup.github.io/redfish-core/externalJS/',(msg)=>{
                    const message=`${msg.status}    ${100*msg.progress}%`
                    console.info(message)
                })
                const dv = document.createElement('div')
                const myResult = {...result,time:result.date.getTime(), sponsor:"Northern Mexico Cricket Racing League"}
                myResult.width = can.width
                myResult.height = can.height
                myResult.aspectRatio = can.width/can.height
                console.log({result, myResult})
                dv.innerHTML = JSON.stringify(result,0,2)
                dv.appendChild(can)
                document.body.appendChild(dv)
                workQ.completeTask(ref, task, myResult)
            } catch(err){
                console.error(err)
                workQ.errorTask(ref,task,err)
            }
        }

        function vidToCanvas(vid) {
            const can = document.createElement('canvas')
            can.crossOrigin="anonymous"
            can.setAttribute('crossorigin', 'anonymous')
            can.width = vid.videoWidth
            can.height = vid.videoHeight
            const ctx = can.getContext('2d')
            ctx.drawImage(vid,0,0)
            return can
        }



    </script>
<h2>Ready for event</h2>
<div>
    <h4>
        Adding an event would look something like this
    </h4>
    <pre>
            const db = firebase.database()
            const aGoodQueue = db.ref().child('awf_v0').child('workerQueue')
            window.addTask = function(mediaObj, mediaTimeSec=3*Math.random()){
                workQ.addTask(aGoodQueue,{
                    mediaObject:mediaObj,
                    mediaTimeSeconds:mediaTimeSec,
                    signed:'horchatasaurus'
                }) 
            }
            addTask("https://acequia.firebaseio.com/awf_v0/cameras/58a0233c-83b2-412d-97b2-49ec74d0e9d3/mediaObjects/7056698d-0f1f-44b8-aa3f-e75aa97ee050")    
        </pre>
</div>

</html>